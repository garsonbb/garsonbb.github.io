<!doctype html><html lang=zh-hans>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=HandheldFriendly content="True">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=generator content="Hugo 0.86.0">
<link rel="shortcut icon" href=https://pic.garnote.top/2021/08/11/eeb6915d14722.ico>
<title>四元数姿态解算-MahonyAHRS - 梦渡</title>
<meta name=author content="Garson">
<meta name=description content="A minimal Hugo theme with nice theme color.">
<meta name=keywords content="控制">
<meta property="og:title" content="四元数姿态解算-MahonyAHRS">
<meta name=twitter:title content="四元数姿态解算-MahonyAHRS">
<meta property="og:type" content="article">
<meta property="og:url" content="https://garnote.top/post/mahonyahrs/"><meta property="og:description" content>
<meta name=twitter:description content><meta property="og:image" content="https://garnote.top/img/og.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://garnote.top/img/og.png"><meta property="article:published_time" content="2021-05-26T00:17:00+00:00"><meta property="article:modified_time" content="2021-05-26T00:17:00+00:00">
<style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style>
<link rel=stylesheet href=https://garnote.top/assets/css/fuji.min.css>
</head>
<body data-theme=auto data-theme-auto=true>
<script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');fujiThemeData?fujiThemeData!=='auto'&&document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light'):localStorage.setItem('fuji_data-theme','auto')</script>
<header>
<div class="container-lg clearfix">
<div class="col-12 header">
<a class=title-main href=https://garnote.top>梦渡</a>
<span class=title-sub>Garson's Note</span>
</div>
</div>
</header>
<main>
<div class="container-lg clearfix">
<div class="col-12 col-md-9 float-left content">
<article>
<h2 class="post-item post-title">
<a href=https://garnote.top/post/mahonyahrs/>四元数姿态解算-MahonyAHRS</a>
</h2>
<div class="post-item post-meta">
<span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-05-26</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;1394 字</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/%E6%8E%A7%E5%88%B6>控制</a>&nbsp;</span>
</div>
<div class="post-content markdown-body">
<h2 id=加速度计和角速度计解算姿态>加速度计和角速度计解算姿态</h2>
<p>在只使用加速度计和陀螺仪融合数据时，流程是这样的：</p>
<ol>
<li>归一化传感器输入的B系加速度
\({\begin{bmatrix}b\_a_x & b\_a_y & b\_a_z\end{bmatrix}}^\top\)
。</li>
<li>把N系重力加速度旋转到B系
\({\begin{bmatrix}n2b\_a_x & n2b\_a_y & n2b\_a_z\end{bmatrix}}^\top\)
。
N系重力加速度就是g，
\({\begin{bmatrix} 0 & 0 & 1\end{bmatrix}}^\top\)
。</li>
<li>把上面两个同在B系的加速度进行叉积运算，得到误差
\({\begin{bmatrix}e\_a_x & e\_a_y & e\_a_z\end{bmatrix}}^\top\)
。（得到误差反映的就是目前解算得到的姿态矩阵与真实姿态之间的误差）。</li>
<li>把上面获得的误差通过PI控制器补偿到传感器输入的角速度。
\({\begin{bmatrix}b\_g_x & b\_g_y & b\_g_z\end{bmatrix}}^\top\)
。</li>
<li>使用上面已经补偿的角速度和一阶龙塔公式更新四元数。</li>
<li>归一化四元数。</li>
</ol>
<p>在这个过程中，就是利用<strong>重力加速度恒等于1g并垂直向下</strong>，来修正由角速度积分得到的姿态矩阵。</p>
<p>接下来确定旋转矩阵的方向：</p>
<p>由
\(q_0=\cos{\frac{\theta}{2}} \quad ,q_1= - \sin{\frac{\theta}{2}}\hat{x} \quad ,
q_2= - \sin{\frac{\theta}{2}}\hat{y} \quad ,q_3= - \sin{\frac{\theta}{2}}\hat{z}\)
可算得下面的两个四元数旋转矩阵。具体计算过程可以看</p>
<blockquote>
<p><a href=https://krasjet.github.io/quaternion/quaternion.pdf target=_blank>Krasjet对于四元数与三维旋转的简单讨论</a></p>
</blockquote>
<blockquote>
<p><a href=https://www.x-io.co.uk/res/doc/madgwick_internal_report.pdf target=_blank>Madgwick的文章</a></p>
</blockquote>
<p>下面的
\(C_n^b\)
和
\(C_b^n\)
是和<a href=https://www.x-io.co.uk/res/doc/madgwick_internal_report.pdf target=_blank>Madgwick的文章</a>
里的一样，<strong>右手坐标系</strong>，由<strong>左手定则</strong>确定<strong>向量</strong>旋转<strong>正方向</strong>。但再实际过程中，重力加速度的指向在航向坐标系和地理坐标系的指向是一样的，旋转的是航向坐标系，所以下面的四元数旋转矩阵实际上是<strong>右手坐标系</strong>，由<strong>右手定则</strong>确定的<strong>航向坐标系</strong>旋转<strong>正方向</strong>。</p>
$$C_n^b=
\begin{bmatrix}
2q_0^2-1+2q_1^2 & 2q_1q_2+2q_0q_3 & 2q_1q_3-2q_0q_2 \\
2q_1q_2-2q_0q_3 & 2q_0^2-1+2q_2^2 & 2q_2q_3+2q_0q_1 \\
2q_1q_3+2q_0q_2 & 2q_2q_3-2q_0q_1 & 2q_0^2-1+2q_3^2
\end{bmatrix}$$
$$C_b^n=
\begin{bmatrix}
2q_0^2-1+2q_1^2 & 2q_1q_2-2q_0q_3 & 2q_1q_3+2q_0q_2 \\
2q_1q_2+2q_0q_3 & 2q_0^2-1+2q_2^2 & 2q_2q_3-2q_0q_1 \\
2q_1q_3-2q_0q_2 & 2q_2q_3+2q_0q_1 & 2q_0^2-1+2q_3^2
\end{bmatrix}$$
<p>为了让欧拉角矩阵与四元数矩阵
\(C_n^b\)
的坐标系对应，下面的三个旋转矩阵都是<strong>右手坐标系</strong>，由<strong>左手定则</strong>确定<strong>向量</strong>旋转<strong>正方向</strong>的。
\(\begin{bmatrix}X\end{bmatrix}\)
指绕x轴旋转(Pitch)，
\(\begin{bmatrix}Y\end{bmatrix}\)
指绕y轴旋转(Roll)，
\(\begin{bmatrix}Z\end{bmatrix}\)
指绕z轴旋转(Yaw)。</p>
$$\begin{bmatrix}\vec{A_b}\end{bmatrix}=\begin{bmatrix}X\end{bmatrix}\begin{bmatrix}Y\end{bmatrix}\begin{bmatrix}Z\end{bmatrix}\begin{bmatrix}\vec{A_n}\end{bmatrix}$$
$$\begin{bmatrix}X\end{bmatrix}=
\begin{bmatrix}
1 & 0 & 0 \\
0 & \cos\theta_x & \sin\theta_x \\
0 & -\sin\theta_x & \cos\theta_x
\end{bmatrix}\;\begin{bmatrix}Y\end{bmatrix}=
\begin{bmatrix}
\cos\theta_y & 0 & -\sin\theta_y \\
0 & 1 & 0 \\
\sin\theta_y & 0 & \cos\theta_y
\end{bmatrix}\;\begin{bmatrix}Z\end{bmatrix}=
\begin{bmatrix}
\cos\theta_z & \sin\theta_z & 0 \\
-\sin\theta_z & \cos\theta_z & 0 \\
0 & 0 & 1
\end{bmatrix}\;$$
$$\begin{bmatrix}X\end{bmatrix}\begin{bmatrix}Y\end{bmatrix}\begin{bmatrix}Z\end{bmatrix}=
\begin{bmatrix}
\cos\theta_z\cos\theta_y & \sin\theta_z\cos\theta_y & -\sin\theta_y \\
-\sin\theta_z\cos\theta_x+\cos\theta_z\sin\theta_y\sin\theta_x & \cos\theta_z\cos\theta_x+\sin\theta_z\sin\theta_y\sin\theta_x & \cos\theta_y\sin\theta_x \\
\sin\theta_z\sin\theta_x+\cos\theta_z\sin\theta_y\cos\theta_x & -\cos\theta_z\sin\theta_x+\sin\theta_z\sin\theta_y\cos\theta_x & \cos\theta_y\cos\theta_x
\end{bmatrix}\;$$
<p>$$
pitch\left( rad \right) = \arctan{ \frac{ 2q_2q_3+2q_0q_1 }{ 2q_0^2-1+2q_3^2 }}
$$</p>
<p>$$
roll\left( rad \right) =- \arcsin{\left( 2q_1q_3-2q_0q_2 \right) }
$$</p>
<p>$$
yaw\left( rad \right) = \arctan{ \frac{2q_1q_2+2q_0q_3 }{ 2q_0^2-1+2q_1^2 }}
$$</p>
<h2 id=地磁校准-yaw>地磁校准 YAW</h2>
<p>在利用加速度计和陀螺仪只能较为准确地确定 ROLL 和 PITCH 角，YAW 角由加速度积分所得，MEMS传感器存在温漂，所以经过长时间积分，YAW角误差会很大。所以要加上地磁传感器来校准YAW角。</p>
<p>在使用加速度计和角速度计解算姿态利用<strong>重力加速度恒等于1g并垂直向下</strong>的特点，与这相似，使用地磁传感器时，利用<strong>地磁场矢量恒指向北极</strong>。
当姿态旋转矩阵的Pitch和Roll角准确时，即现实中的B系和计算得到B系的z轴重叠（XOY平面重叠）时，把从地磁传感器获得地磁场在B系的矢量
\({\begin{bmatrix}b\_m_x & b\_m_y & b\_m_z\end{bmatrix}}^\top\)
旋转到N系
\({\begin{bmatrix}b2n\_m_x & b2n\_m_y & b2n\_m_z\end{bmatrix}}^\top\)
。
在计算得到
\({\begin{bmatrix}n\_m_{north} & 0 & n\_m_{sky}\end{bmatrix}}^\top\)
就是需要的恒定矢量。</p>
<p>只需要加速度计和陀螺仪融合数据时的过程2和3之间加入以下过程。</p>
<ol>
<li>
<p>归一化传感器输入的B系地磁矢量
\( {\begin{bmatrix}b\_m_x & b\_m_y & b\_m_z\end{bmatrix}}^\top
\)
。把B系地磁矢量旋转到N系
\( {\begin{bmatrix}b2n\_m_x & b2n\_m_y & b2n\_m_z\end{bmatrix}}^\top
\)
。</p>
$$ {\begin{bmatrix}b2n\_m_x \\ b2n\_m_y \\ b2n\_m_z\end{bmatrix}} = C^n_b\cdot {\begin{bmatrix}b\_m_x \\ b\_m_y \\ b\_m_z\end{bmatrix}}
$$
</li>
<li>
<p>利用
\( {\begin{bmatrix}b2n\_m_x & b2n\_m_y & b2n\_m_z\end{bmatrix}}^\top
\)
算得在<em>x轴指向北极的坐标系</em>中指向北极的矢量
\( {\begin{bmatrix}n\_m_{north} & 0 & n\_m_{sky}\end{bmatrix}}^\top
\)
，再把他转换回 b 系得到
\( {\begin{bmatrix}n2b\_m_x & n2b\_m_y & n2b\_m_z\end{bmatrix}}^\top
\)
。
$$ {\begin{bmatrix}n\_m_{north} \\ 0 \\ n\_m_{sky}\end{bmatrix}} = {\begin{bmatrix}({b2n\_m_{x}^2+b2n\_m_{y}^2)}^{1/2} \\ 0 \\ b2n\_m_{sky}\end{bmatrix}}
$$
</p>
$$ {\begin{bmatrix}n2b\_m_x \\ n2b\_m_y \\ n2b\_m_z\end{bmatrix}} = C^b_n \cdot {\begin{bmatrix}n\_m_{north} \\ 0 \\ n\_m_{sky}\end{bmatrix}}
$$
</li>
<li>
<p>叉积计算误差，误差补偿。
$$ {\begin{bmatrix}e\_m_x \\ e\_m_y \\ e\_m_z\end{bmatrix}} = {\begin{bmatrix}n2b\_m_x \\ n2b\_m_y \\ n2b\_m_z\end{bmatrix}} \times {\begin{bmatrix}b\_m_x \\ b\_m_y \\ b\_m_z\end{bmatrix}}
$$
$$ {\begin{bmatrix}e\_x \\ e\_y \\ e\_z\end{bmatrix}} = {\begin{bmatrix}n2b\_m_x \\ n2b\_m_y \\ n2b\_m_z\end{bmatrix}} \times {\begin{bmatrix}b\_m_x \\ b\_m_y \\ b\_m_z\end{bmatrix}} + {\begin{bmatrix}e\_a_x \\ e\_a_y \\ e\_a_z\end{bmatrix}}
$$
</p>
</li>
</ol>
<h2 id=一些思考>一些思考</h2>
<ol>
<li>同一姿态角情况下，在加速运动时测得加速度，与稳定状态下的加速度不相同，会引起姿态角的误差。</li>
<li>地磁传感器校正时，运算过程中去掉z轴分量，可能会降低噪音？效果更好？</li>
<li>在把误差补偿到角速度时，用了一个PI控制器，作用应该是类似一个作用与于误差的滤波器。</li>
</ol>
<h2 id=参考文献>参考文献</h2>
<p><a href=https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/ target=_blank>Open source IMU and AHRS algorithms - 1</a></p>
<p><a href=https://www.x-io.co.uk/res/doc/madgwick_internal_report.pdf target=_blank>Open source IMU and AHRS algorithms - 2</a></p>
<p><a href=https://krasjet.github.io/quaternion/quaternion.pdf target=_blank>Krasjet对于四元数与三维旋转的简单讨论</a></p>
</div>
</article>
<div class="license markdown-body">
<blockquote>
<p>除特殊注明部分，本站内容采用 <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a> 进行许可。</p>
</blockquote>
</div>
<div id=tcomment></div>
<script src=https://cdn.jsdelivr.net/npm/twikoo@1.4.3/dist/twikoo.all.min.js></script>
<script>twikoo.init({envId:'https://my-twikoo-8ibqhllap-z1195224900-gmailcom.vercel.app/',el:'#tcomment'})</script>
</div>
<aside class="col-12 col-md-3 float-left sidebar">
<div class="sidebar-item sidebar-pages">
<h3>页面</h3>
<ul>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/archives/>Archives</a>
</li>
<li>
<a href=/board/>Board</a>
</li>
<li>
<a href=/about/>About</a>
</li>
<li>
<a href=/search/>Search</a>
</li>
<li>
<a href=/index.xml>RSS</a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-links">
<h3>链接</h3>
<ul>
<li>
<a href=https://github.com/garsonbb target=_blank><span>GitHub</span></a>
</li>
<li>
<a href=https://space.bilibili.com/12225878 target=_blank><span>Bilibili</span></a>
</li>
<li>
<a href=mailto:z1195224900@gmail.com target=_blank><span>Email</span></a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-tags">
<h3>标签</h3>
<div>
<span>
<a href=/tags/clion/>Clion</a>
</span>
<span>
<a href=/tags/diy/>DIY</a>
</span>
<span>
<a href=/tags/nas/>Nas</a>
</span>
<span>
<a href=/tags/stm32/>STM32</a>
</span>
<span>
<a href=/tags/unraid/>Unraid</a>
</span>
<span>
<a href=/tags/%E6%8E%A7%E5%88%B6/>控制</a>
</span>
<span>
<a href=/tags/%E6%91%84/>摄</a>
</span>
<span>
<a href=/tags/%E6%97%A5%E5%B8%B8/>日常</a>
</span>
<span>
<a href=/tags/%E6%9D%82/>杂</a>
</span>
</div>
</div>
<div class="sidebar-item sidebar-toc">
<h3>目录</h3><nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#加速度计和角速度计解算姿态>加速度计和角速度计解算姿态</a></li>
<li><a href=#地磁校准-yaw>地磁校准 YAW</a></li>
<li><a href=#一些思考>一些思考</a></li>
<li><a href=#参考文献>参考文献</a></li>
</ul>
</li>
</ul>
</nav></div>
</aside>
</div>
<div class=btn>
<div class=btn-menu id=btn-menu>
<i class="iconfont icon-grid-sharp"></i>
</div>
<div class=btn-toggle-mode>
<i class="iconfont icon-contrast-sharp"></i>
</div>
<div class=btn-scroll-top>
<i class="iconfont icon-chevron-up-circle-sharp"></i>
</div>
</div>
<aside class=sidebar-mobile style=display:none>
<div class=sidebar-wrapper>
<div class="sidebar-item sidebar-pages">
<h3>页面</h3>
<ul>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/archives/>Archives</a>
</li>
<li>
<a href=/board/>Board</a>
</li>
<li>
<a href=/about/>About</a>
</li>
<li>
<a href=/search/>Search</a>
</li>
<li>
<a href=/index.xml>RSS</a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-links">
<h3>链接</h3>
<ul>
<li>
<a href=https://github.com/garsonbb target=_blank><span>GitHub</span></a>
</li>
<li>
<a href=https://space.bilibili.com/12225878 target=_blank><span>Bilibili</span></a>
</li>
<li>
<a href=mailto:z1195224900@gmail.com target=_blank><span>Email</span></a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-tags">
<h3>标签</h3>
<div>
<span>
<a href=/tags/clion/>Clion</a>
</span>
<span>
<a href=/tags/diy/>DIY</a>
</span>
<span>
<a href=/tags/nas/>Nas</a>
</span>
<span>
<a href=/tags/stm32/>STM32</a>
</span>
<span>
<a href=/tags/unraid/>Unraid</a>
</span>
<span>
<a href=/tags/%E6%8E%A7%E5%88%B6/>控制</a>
</span>
<span>
<a href=/tags/%E6%91%84/>摄</a>
</span>
<span>
<a href=/tags/%E6%97%A5%E5%B8%B8/>日常</a>
</span>
<span>
<a href=/tags/%E6%9D%82/>杂</a>
</span>
</div>
</div>
<div class="sidebar-item sidebar-toc">
<h3>目录</h3>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#加速度计和角速度计解算姿态>加速度计和角速度计解算姿态</a></li>
<li><a href=#地磁校准-yaw>地磁校准 YAW</a></li>
<li><a href=#一些思考>一些思考</a></li>
<li><a href=#参考文献>参考文献</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</aside>
</main>
<footer>
<div class="container-lg clearfix">
<div class="col-12 footer">
<span>&copy; 2019-2021
<a href=https://garnote.top>Garson</a>
| <a href=https://github.com/dsrkafuu/hugo-theme-fuji>Source code</a>
| 基于 <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a> 构建
</span>
</div>
</div>
</footer>
<script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=/assets/js/fuji.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
</body>
</html>